Sail4j to develop Rule for IdentityIQ or IdentityNow
================================

# Summary
This repository demonstrate how to use Sail4j to develop Rules for IdentityIQ or IdentityNow projects. 

There are 2 different ways to use Sail4j:

- Integreate with SSB (Standard Service Build, the latest version is v7.0.1 at the time of writing). This typically applies to an IdentityIQ project as most IdentityIQ implementation projects use SSB.
- Integrate with Maven. This can be useful in a scenario where you already have a project hosting all code related to you IdentityIQ or IdentityNow, and you just need another simple java project where you can develop and unit test your rules. Once rules are generated by Sail4j, you will copy the Rule XML files to your original project.

## Use Sail4j with SSB (Standard Service Build)

- Add the following to build.xml file:

 		<!-- generate Rules from Java code -->
    	<taskdef name="genRule" classname="com.sailpoint.sail4j.ant.GenerateRuleTask">
			<classpath>
	            <fileset dir="lib/sail4j">
	            	<include name="*.jar"/>
	          	</fileset>
	          	<fileset dir="lib">
	            	<include name="*.jar"/>
	          	</fileset>
	        </classpath>
		</taskdef>
    	<genRule sourceFilePath="src/com/demo/rule" destinationXmlFilePath="config/Rule"/>
    	
- Copy the following jar files to the folder **lib/sail4j**:

 		commons-collections-3.2.jar
 		slf4j-api-1.6.1.jar
 		javaparser-core-3.18.0.jar
 		sail4j-ant-task-1.1.jar
 		sail4j-api-1.1.jar
 		sail4j-transform-1.1.jar
 		velocity-1.6.2.jar
 		velocity-tools-2.0.jar


## Use Sail4j with Maven

### Install Apache Maven

Download Apache Maven 3.6.x or higher from [https://maven.apache.org/download.cgi](https://maven.apache.org/download.cgi). Installation is simply extracting the compressed archive, setting the M2_HOME environment variable and adding the $M2_HOME/bin to your $PATH. For example in Mac, just modify the file **.bash_profile** to add the Maven installation folder to PATH as below:

 		export M2_HOME=/Users/bruce.ren/Desktop/tools-install/apache-maven-3.6.3
		...
		export PATH=$PATH:$ANT_HOME/bin:$M2_HOME/bin
                                
### Install IdentityIQ and dependencies jars into local Maven repository
- Download the IdentityIQ base GA (e.g. **IdentityIQ 8.3.zip**) from Compass. The version of IIQ doesn't matter because it is only used to compile your java code which will be eventually converted to IDN Rules.

- Open the file **sail4j-iiq-idn/mvn-install/install-iiq-jars.sh** to modify the following 2 lines to match the version and location of IdentityIQ you download:

 		export IIQ_VERSION=8.3
 		export BASE_SOFTWARE_PATH=/Users/bruce.ren/Desktop/tools-install/iiq-install/base	            	
- Go to folder **sail4j-iiq-idn/mvn-install** to run the **install-iiq-jars.sh**, it takes a few minutes to install all the jar files.

		./install-iiq-jars.sh

### Install Sail4j jars into local Maven repository
- Modify the file **sail4j-iiq-idn/sail4j-bundle/sail4j-test-helper.pom.xml** to update the version of IdentityIQ configured in the previous step:

		<properties>
    		<IdentityIQ.Version>8.3</IdentityIQ.Version>
  		</properties>

- Go to folder **sail4j-iiq-idn/mvn-install** to run the **install-sail4j-jars.sh**.

		./install-sail4j-jars.sh


### Create Maven project
- Now you can create a Maven project by using the template project included in the following folder:

       sail4j-iiq-idn/maven-template

- Modify pom.xml to update groupId and artifactId if necessary. Please note this folder also includes 2 examples (with corresponding Junit test cases) for the reference.
- Import the project directory into Eclipse (or Intellij) as a Maven project.

# How to use Sail4j to develop Rule
-  You develop your IIQ or IDN Rule in a standard Java class but use Sail4j annotations to describe Rule. Here is an example:

 		package com.demo.rule;
 		
		import org.apache.commons.lang.StringUtils;
		import org.apache.commons.logging.Log;
		import org.apache.commons.logging.LogFactory;
		
		import com.sailpoint.sail4j.annotation.IgnoredBySailPointRule;
		import com.sailpoint.sail4j.annotation.SailPointRule;
		import com.sailpoint.sail4j.annotation.SailPointRule.RuleType;
		import com.sailpoint.sail4j.annotation.SailPointRuleMainBody;
	
		import sailpoint.api.SailPointContext;
		import sailpoint.connector.ConnectorException;
		import sailpoint.object.Application;
		import sailpoint.object.Identity;
		import sailpoint.tools.GeneralException;

		@SailPointRule(name = "ActiveDirectorySAMAccountName", type = RuleType.FIELD_VALUE, 
			referencedRules = {"Rule-Library-General", "Rule-Library-ActiveDirectory-Search"})
		public class ActiveDirectorySAMAccountNameFieldValueRule {
	
			private static Log ruleLog = LogFactory.getLog("rule.library.active.directory");
			
			@IgnoredBySailPointRule
			private String notUsed;
			
			@IgnoredBySailPointRule
			//Dummy method. The real method is actually inside one of referenced rule libraries.
			public boolean userNameExistInActiveDirectory(SailPointContext context, Identity identity, Application application,
					String strUserName) throws GeneralException, ConnectorException {
				return false;
			}
		
			//Construct will be ignored when generating Rule
			public ActiveDirectorySAMAccountNameFieldValueRule() {
				
			}
		
			public String getActiveDirectoryUniqueName(SailPointContext context, Identity identity,
					Application adApplication, boolean escapeName) throws GeneralException, ConnectorException {
				ruleLog.debug("=== Generate Active Directory Unique username ===");
				
				String strUserName = "";
				try {
					String strFirstName = identity.getFirstname();
					String strLastName = identity.getLastname();
					
					// Code to handle unusual case of names are blank
					if (StringUtils.isEmpty(strFirstName) || StringUtils.isEmpty(strLastName)) {
						ruleLog.debug("=== strFirstName and or strLastName is null/empty ===");
						return "";
					}
		
					// Code to Replace special characters from the last name
					if (!StringUtils.isBlank(strLastName)) {
						strLastName = strLastName.replaceAll("[^a-zA-Z0-9]+", "").toUpperCase();
					}
					if (!StringUtils.isBlank(strFirstName)) {
						strFirstName = strFirstName.replaceAll("[^a-zA-Z0-9]+", "").toUpperCase();
					}
					
					// Code to get the first initial of First Name in a variable
					String strFirstNameSub = StringUtils.substring(strFirstName, 0, 1);
				
					String strLastNameSub = "";
		
					strUserName = strLastName + strFirstNameSub;
					ruleLog.debug("adAccountName created initially: " + strUserName);
		
					int iLength = StringUtils.length(strUserName);
					ruleLog.debug("Length of the adAccountName created initially: " + iLength);
					// Code to get the basic adAccountName
					if (iLength > 8) {
						strLastNameSub = StringUtils.substring(strLastName, 0, 8 - iLength);
						ruleLog.debug("strLastNameSub 8-iLength" + strLastNameSub);
						strUserName = strLastNameSub + strFirstNameSub;
						ruleLog.debug("adAccountName created after checking length: " + strUserName);
					}
					do {
						// Check if the calculated username exists in AD
						if (!userNameExistInActiveDirectory(context, identity, adApplication, strUserName)) {
							break;
						}
						// Check the numeric value added to create the unique adAccountName
						String strUser = strUserName.replaceAll("[^0-9]", "");
						int iNumber = 0;
						if (!StringUtils.isBlank(strUser)) {
							iNumber = Integer.valueOf(strUser).intValue();
						}
						int iLengthNumber = String.valueOf(iNumber + 1).length();
						// Create the adAccountName by adding numeric values to make it generic
						strLastNameSub = StringUtils.substring(strLastName, 0, 7 - iLengthNumber);
						strUserName = strLastNameSub + strFirstNameSub;
						iNumber++;
						strUserName += iNumber;
						ruleLog.debug("adAccountName generated with numbers after duplicate found: " + strUserName);
							
					} while (true);
					
					ruleLog.debug("Final User ID created for the new Identity: " + strUserName);
				} catch (Exception ex) {
					ruleLog.error("Exception while calcualting Identity adAccountName: ", ex);
					return "";
				}
					return strUserName;
				}
				
				@SailPointRuleMainBody
				public String executeRule(SailPointContext context, Identity identity, Application application) 
						throws GeneralException, ConnectorException {
				    String userName = getActiveDirectoryUniqueName(context, identity, application, true);
				   
					return userName;
				}
			}

- Then when you run SSB or Maven build command, Sail4j will covert the java classes to Rules based on the values you specified in the annotations (such as Rule name, Rule type, Rule file name, dependent rule library etc.). This approach of development provides a few key benefits:
	- The Rule will be gareented to be syntax error free. Your Jave IDE such as Eclipse or Intellij will do the syntax check for you when you develop your Rule.
	- You can write unit test code to test your Rules. There are large collection of libraries in the Java open-source ecosystem that you use to test your code. For example, you can use JUnit and Mockito to write unit test cases and simulate IdentityIQ or IdentityNow API.  
This repository demonstrate how to use Sail4j to develop Rules for IdentityIQ or IdentityNow projects. 